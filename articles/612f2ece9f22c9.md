---
title: "Arduinoã§DAWã‹ã‚‰BPMã‚’å–å¾—ã™ã‚‹"
emoji: "ğŸ¶"
type: "tech"
topics: ["Arduino", "cpp", "MIDI", "DAW", "DTM"]
published: true
---

<!-- 240812 -->

## ã¯ã˜ã‚ã«

ã€Œã¼ããŒã‹ã‚“ãŒãˆãŸã•ã„ãã‚‡ã†ã®MIDIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€ã‚’ä½œã‚‹éç¨‹ã§å‰¯ç”£ç‰©ãŒå°‘ã—ã°ã‹ã‚Šç”Ÿã¾ã‚ŒãŸã®ã§ã€å¯èƒ½ãªç¯„å›²ã§æ›¸ãèµ·ã“ã—ã¾ã™ã€‚è«¸ã€…ã®å‰æçŸ¥è­˜ã‚’ã™ã£é£›ã°ã—ã¾ã™ã®ã§ã”äº†æ‰¿ãã ã•ã„ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯GitHubã«ã‚‚è¼‰ã›ã¦ã„ã¾ã™ã€‚

https://github.com/aSumo-1xts/MIDI-HARD/tree/main/Arduino/Clock-and-BPM

## ç’°å¢ƒ

- Windows 11
- Arduino IDE 2.3.3
- Ableton Live 12 Suite

## èƒŒæ™¯ã¨ç›®çš„

Arduinoã§Ableton Liveã‹ã‚‰BPMã‚’å–å¾—ã—ãŸã„ã§ã™ã€‚é©å½“ã«æ¤œç´¢ã‚’ã‹ã‘ã‚‹ã¨Arduinoå´ã‚’MIDIã‚¯ãƒ­ãƒƒã‚¯ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã¨ã—ã¦é‹ç”¨ã™ã‚‹æ–¹æ³•ãŒå¤šããƒ’ãƒƒãƒˆã—ã¾ã™ãŒã€å®Ÿéš›ã®æ¼”å¥å ´é¢ã‚’è€ƒãˆã‚‹ã¨ã‚¯ãƒ­ãƒƒã‚¯ã®ä¸»å°æ¨©ã¯Liveå´ã«æ¡ã‚‰ã›ãŸæ–¹ãŒå®‰å¿ƒã§ã™ã€‚

DAWã«ã‚ˆã£ã¦ã¯MIDIã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã¨ã„ã†å†…éƒ¨ãƒ‡ãƒ¼ã‚¿çš„ãªã‚‚ã®ã‚’åãå‡ºã—ã¦ãã‚Œã‚‹ã‚“ã§ã™ãŒã€Ableton Liveã¯[å…¬å¼ã®ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸](https://help.ableton.com/hc/ja/articles/209071149-MIDI%E3%81%A7Live%E3%82%92%E5%90%8C%E6%9C%9F%E3%81%99%E3%82%8B "MIDIã§Liveã‚’åŒæœŸã™ã‚‹")æ›°ã

> MIDIã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆMTCï¼‰ã®å‡ºåŠ›ï¼š Liveã¯å—ä¿¡ã™ã‚‹MIDIã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã¨åŒæœŸã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€Liveã ã‘ã§ã¯ã€MIDIã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãŸã ã—ã€ MIDIã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã™ã‚‹Maxã®ãƒ‡ãƒã‚¤ã‚¹ ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆMax RuntimeãŒå¿…è¦ã§ã™ï¼‰ã€‚

ã¨ã®ã“ã¨ãªã®ã§ã€ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã¯è«¦ã‚ã¦

1. Liveã‹ã‚‰åŒæœŸã‚¯ãƒ­ãƒƒã‚¯ã‚’å‡ºåŠ›
2. Arduinoã§å—ä¿¡ã—ã¦BPMã«å¤‰æ›

ã®æ–¹å‘æ€§ã§è¡Œãã“ã¨ã«ã—ã¾ã—ãŸã€‚

**ã‚‚ã£ã¨ã‚‚Pushã‚·ãƒªãƒ¼ã‚ºã¯æ™®é€šã«BPMã®èª­ã¿æ›¸ããŒå¯èƒ½ãªã®ã§ã€ã‚¿ã‚¤ãƒ ã‚³ãƒ¼ãƒ‰ã®æ©Ÿèƒ½è‡ªä½“ã¯å‚™ã‚ã£ã¦ã„ã¦æˆ‘ã€…ã«è§£æ”¾ã•ã‚Œã¦ã„ãªã„ã ã‘ãªã‚“ã˜ã‚ƒãªã„ã‹ã¨ç–‘ã£ã¦ã„ã¾ã™ãŒâ€¦**

## ã‚¹ã‚±ãƒƒãƒ

å®Ÿã¯[MIDIUSBãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://github.com/arduino-libraries/MIDIUSB.git "MIDIUSB Library for Arduino")ã®`example`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€æœ¬è¨˜äº‹ã¨å…¨ãåŒã˜ç›®çš„ã§æ›¸ã‹ã‚ŒãŸ`MIDIUSB_clock.ino`ãªã‚‹ã‚¹ã‚±ãƒƒãƒãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã‚’ä¸‹æ•·ãã«ã—ã¤ã¤ã€[ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ](https://forum.arduino.cc/t/missing-midi-in-messages-with-midiusb-library-and-arduino-micro/453585 "Missing Midi In messages with MIDIUSB library and Arduino Micro")ãªã©ã‚‚å‚è€ƒã«ã—ã¾ã—ãŸã€‚

### ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ver

#### MIDIUSBãƒ©ã‚¤ãƒ–ãƒ©ãƒªç‰ˆ

```cpp:getBPM-MIDIUSB.ino
#include <MIDIUSB.h>


void getSerialMIDI(int16_t *vals) {
    int16_t kago[3] = {-1, -1, -1};
    midiEventPacket_t rx;       // Open the mailbox. If empty, header=0.

    do {                        // Retrieve received letters and store them in kago.
        rx = MidiUSB.read();
        if (rx.header != 0) {
            kago[0] = rx.byte1; // read command byte
            kago[1] = rx.byte2; // read next byte
            kago[2] = rx.byte3; // read final byte
        }
    } while (rx.header != 0);   // Repeat until mailbox is empty.

    for (uint8_t i=0; i<3; i++) {
        vals[i] = kago[i];
    }
}


uint16_t    BPM       = 0;  //!< global BPM
uint8_t     ppqn      = 0;  //!< 24 Pulses Per Quarter Note
uint32_t    startTime = 0;  //!< for Timer
void clock2BPM() {
    float   preBPM = 0;         // temporary BPM as a result of a single calculation
    int16_t MIDIvals[3];        // means kago

    getSerialMIDI(MIDIvals);    // Bring the letters from the mailbox into the living room.

    if (MIDIvals[0] == 0xF8) {  // System Realtime Message about Clock.
        if (ppqn == 0) {                        // the first Clock
            startTime = micros();               // start Timer
        }
        ppqn++;                                 // count up Clock

        if (ppqn > 24) {                        // 24 Clocks = 1 bar
            preBPM  = 6.0e+07 / float(micros() - startTime);    // stop Timer, calculate BPM
            if(20 <= preBPM && preBPM <= 999) {                 // adopt if reasonable
                BPM = round(preBPM);
            }
            Serial.println(BPM);                // or just "Serial.println(preBPM)"
            ppqn = 0;                           // reset Clock
        }
    }
}


//! @brief setup function
void setup() {
    Serial.begin(115200);
}


//! @brief loop function
void loop() {
    clock2BPM();
}
```

ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å‡ºé±ˆç›®ã«è‹±èªã§æ›¸ã„ã¦ã—ã¾ã£ãŸã®ã§ã‚¢ãƒ¬ã§ã™ãŒã€å¤§ä½“ã®æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. DAWã‹ã‚‰ã¯1/24æ‹ã®é–“éš”ã§ã‚¯ãƒ­ãƒƒã‚¯ãŒé€ã‚‰ã‚Œã¦ãã‚‹
2. ã“ã‚Œã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ãŠã„ã¦ã€24ã‚¯ãƒ­ãƒƒã‚¯ã«ãªã£ãŸã‚‰1æ‹ã¨ã—ã¦è¨˜éŒ²
3. BPMã«æ›ç®—ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã¯ãƒªã‚»ãƒƒãƒˆï¼‰

ç‰¹ã«`getSerialMIDI`é–¢æ•°ã®`0xF8`ãªã‚‹å®šæ•°ã€ã“ã„ã¤ãŒæ§‹é€ ä½“`midiEventPacket_t`ã®å…ˆé ­ã¨ã—ã¦é£›ã³è¾¼ã‚“ã§ããŸã‚‰ã€Œã‚¯ãƒ­ãƒƒã‚¯ãŒæ¥ãŸãï¼ã€ã®åˆå›³ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚

#### Control Surfaceãƒ©ã‚¤ãƒ–ãƒ©ãƒªç‰ˆ

ã»ã¨ã‚“ã©åŒã˜ä»•çµ„ã¿ã§ã€MIDIUSBãƒ©ã‚¤ãƒ–ãƒ©ãƒªã˜ã‚ƒãªã[Control Surfaceãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://github.com/tttapa/Control-Surface.git "Control Surface")ã‚’ä½¿ã£ã¦æ›¸ãã“ã¨ã‚‚ã§ãã¾ã—ãŸã€‚Control Surfaceã¯ã‚ã¡ã‚ƒãã¡ã‚ƒä¾¿åˆ©ãªç¥ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

```cpp:getBPM-Control_Surface.ino
#include <Control_Surface.h>
USBMIDI_Interface midi_usb;


uint16_t  BPM       = 0;  //!< global BPM
uint8_t   ppqn      = 0;  //!< 24 Pulses Per Quarter Note
uint32_t  startTime = 0;  //!< for Timer
bool realTimeMessageCallback(RealTimeMessage rt) {
    float preBPM = 0;                   // temporary BPM as a result of a single calculation

    if (ppqn == 0) {                    // the first Clock
        startTime = micros();           // start Timer
    }
    ppqn++;                             // count up Clock

    if (ppqn > 24) {                    // 24 Clocks = 1 bar
        preBPM  = 6.0e+07 / float(micros() - startTime);    // stop Timer, calculate BPM
        if(20 <= preBPM && preBPM <= 999) {                 // adopt if reasonable
            BPM = round(preBPM);
        }
        Serial.println(BPM);            // or just "Serial.println(preBPM)"
        ppqn = 0;                       // reset Clock
    }

    return true;
}


//! @brief setup function
void setup() {
    Control_Surface.begin();
    Control_Surface.setMIDIInputCallbacks(nullptr, nullptr, nullptr, realTimeMessageCallback);
}


//! @brief loop function
void loop() {
    Control_Surface.loop();
}
```

ã“ã¡ã‚‰ã®Control Surfaceç‰ˆã¯å‹•ä½œã®æœ€ä¸­ã«Arduino IDEã®ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ã‚’é–‹é–‰ã™ã‚‹ã¨ä½•æ•…ã‹åœæ­¢ã—ã¾ã™ãŒã€å®Ÿéš›ã®ä½¿ç”¨çŠ¶æ³ã§ã¯ãã‚‚ãã‚‚IDEã‚’é–‹ã‹ãªã„ã®ã§ãƒ¨ã‚·ï¼ã¨ã—ã¦ã„ã¾ã™ã€‚ã¨ã¯è¨€ãˆã‚ã¾ã‚Šå¥å…¨ã§ã¯ãªã„ã®ã§ã€ã‚†ã‚‹ã‚†ã‚‹ã¨åŸå› èª¿æŸ»ä¸­ã§ã™ã€‚

#### çµæœ

Liveã®å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦BPM=120ã®ã‚¯ãƒ­ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¾ã›ãŸã¨ã“ã‚ã€ã¨ã‚Šã‚ãˆãšBPMã‚’æ•™ãˆã¦ãã‚Œã¾ã—ãŸï¼ˆåˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«é–¢ã‚ã‚‰ãšåŒæ§˜ã§ã™ï¼‰ã€‚ã—ã‹ã—ãªãŒã‚‰ã€BPM=120ã®ã¯ãšãªã®ã«å€¤ãŒã‹ãªã‚Šãƒ–ãƒ¬ãƒ–ãƒ¬ã§ã™ã€‚ã“ã®ã‚ã¨BPM=200ã¨ã‹ã«ãªã‚‹ã¨ã‚‚ã£ã¨é…·ã„ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

![ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ver](/images/240812_01.png)

### èª¤å·®ä½æ¸›ver

ä½•ã¨ã‹ãªã‚‰ãªã„ã‹ã¨æ€ã„ã€å››æ¨äº”å…¥ã‚„ã‚‰ãƒ­ãƒ¼ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚„ã‚‰è‰²ã€…ã¨è©¦ã—ã¦ã¿ã¾ã—ãŸãŒçµæœã¯ã‚ã¾ã‚ŠèŠ³ã—ããªã‹ã£ãŸã§ã™ï¼ˆä¸Šã€ã‚¹ã‚¯ã‚·ãƒ§æ’®ã‚Šå¿˜ã‚Œï¼‰ã€‚ã¡ãªã¿ã«Liveã‚ˆã‚ŠStudio Oneã®æ–¹ãŒã‚¯ãƒ­ãƒƒã‚¯ç²¾åº¦ã¯é«˜ã„ã‚ˆã†ã§ï¼ˆä¸‹ï¼‰ã€ãªãœãªã‚“ã ï½ã¨æ€ã„ã¤ã¤æ‰‹ã‚’å¼•ãã“ã¨ã«ã—ã¾ã—ãŸã€‚

![èª¤å·®ä½æ¸›ver](/images/240812_02.jpg)

![èª¤å·®ä½æ¸›verï¼ˆStudio Oneï¼‰](/images/240812_03.jpg)

## ãŠã‚ã‚Šã«

ã‚ã‚ã‚ˆãã°Arduinoå´ã§7ã‚»ã‚°LEDã‚’ä½¿ã£ã¦BPMã‚’é€ä¸€è¡¨ç¤ºï½ã¨ã‹å¦„æƒ³ã—ã¦ãŸã‚“ã§ã™ãŒã€ã“ã†ã‚‚å€¤ãŒãƒ–ãƒ¬ã‚‹ã¨æ¼”å¥ä¸­ã«ã¯é€†åŠ¹æœã§ã™ã€‚é›»æºå‘¨ã‚Šã¨ã‹ã‚‚å«ã‚ã¦ãã‚Œãªã‚Šã«è‰²ã€…è©¦ã—ãŸã‚“ã§ã™ãŒä»Šã®ã¨ã“ã‚åŠ¹æœã¯ç„¡ã„ã®ã§ã€ä½•ã‹æ”¹å–„æ¡ˆã‚’ãŠæŒã¡ã®æ–¹ãŒã„ãŸã‚‰æ˜¯éãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚ä»Šã®ã¾ã¾ã§ã‚‚å˜ç´”ã«LEDã‚’ç‚¹æ»…ã•ã›ã‚Œã°è¦–è¦šçš„ãªãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ãã‚‰ã„ã«ã¯ãªã‚‹ã‹ãªâ€¦